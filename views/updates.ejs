<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Updates</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .updates-wrapper{display:flex;flex-direction:column;gap:1rem;}
    .updates-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.75rem;}
    .update-item{padding:.65rem .75rem;border:1px solid var(--color-border);border-radius:6px;background:var(--color-surface);font-size:.75rem;line-height:1.3;display:flex;flex-direction:column;}
    .update-item time{font-size:.6rem;color:var(--color-text-light);margin-bottom:.15rem;}
    .empty{opacity:.6;font-style:italic;}
  </style>
</head>
<body class="app">
  <%- include('partials/header', { activePage:'updates', user:user }) %>
  <main class="app-main">
    <section class="card" id="updatesSection" aria-live="polite">
      <h1 class="page-title">Updates</h1>
      <p class="subtle">Signed in as <strong><%= user.email %></strong></p>
      <ul id="updatesList" class="updates-list">
        <li class="skeleton"></li>
        <li class="skeleton"></li>
        <li class="skeleton"></li>
      </ul>
    </section>
  </main>
  <footer class="app-footer">
    <small>&copy; <span id="year"></span> Activity Tracker</small>
  </footer>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const toggleBtn = document.getElementById('toggleTheme');
    const stored = localStorage.getItem('theme'); if(stored){ document.documentElement.dataset.theme = stored; }
    toggleBtn && toggleBtn.addEventListener('click', ()=>{ const next=document.documentElement.dataset.theme==='dark'?'light':'dark'; document.documentElement.dataset.theme=next; localStorage.setItem('theme',next); });
    function medal(r){ if(r===1) return 'ðŸ¥‡'; if(r===2) return 'ðŸ¥ˆ'; if(r===3) return 'ðŸ¥‰'; return ''; }
    function rankStr(r){ return r? ('#'+r+medal(r)) : '#?'; }
    function describe(ev){ const name = ev.user?.name || ev.userId || 'User'; const meters = (ev.totalMeters||0).toLocaleString('en-US');
      switch(ev.type){
        case 'top3-enter': return `${name} entered Top 3 at ${rankStr(ev.newRank)} (${meters} m)`;
        case 'top3-exit': return `${name} left Top 3 from ${rankStr(ev.prevRank)} (${meters} m)`;
        case 'top3-change': return `${name} moved from ${rankStr(ev.prevRank)} to ${rankStr(ev.newRank)} (${meters} m)`;
        case 'goal-milestone': return `${name} reached ${Math.round(ev.milestonePct*100)}% goal (${meters} m) ${ev.newRank&&ev.newRank<=3? rankStr(ev.newRank):''}`;
        default: return `${name} update (${meters} m)`;
      }
    }
    function render(list){ const ul=document.getElementById('updatesList'); if(!ul) return; if(!list.length){ ul.innerHTML='<li class="empty">No updates yet.</li>'; return; } ul.innerHTML=list.map(ev=>`<li class='update-item'><time datetime='${ev.date}'>${(ev.date||'').slice(0,10)}</time><span>${describe(ev)}</span></li>`).join(''); }
    fetch('/api/updates?limit=50').then(r=>r.json()).then(d=>{ if(!d.ok) throw new Error('bad'); render(d.items||[]); }).catch(()=>{ render([]); });
  </script>
</body>
</html>