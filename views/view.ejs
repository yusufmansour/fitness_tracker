<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Data View - Activity Tracker</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="app">
  <%- include('partials/header', { activePage:'data', user:{ id: (typeof user!=='undefined' && user && user.id) ? user.id : null } }) %>
  <main class="app-main" style="grid-template-columns:1fr;">
    <section class="card" style="display:flex; flex-direction:column; gap:1rem;">
      <h1 class="page-title" style="font-size:1.5rem; margin-bottom:.25rem;">Your Data</h1>
      <p class="subtle" style="margin-top:-.6rem;">Entries now auto-categorized as meters.</p>
      <div class="filters" style="display:flex; gap:.75rem; flex-wrap:wrap;">
        <div class="field" style="flex:1 1 160px; min-width:160px;">
          <label for="filterDate">Date</label>
          <input id="filterDate" type="date">
        </div>
        <div class="actions" style="align-self:flex-end; display:flex; gap:.5rem;">
          <button id="clearFilters" class="btn small" type="button">Clear</button>
        </div>
      </div>
      <div class="table-wrap" style="overflow-x:auto;">
        <table class="data-table" id="entriesTable" aria-describedby="tableCaption">
          <caption id="tableCaption" class="sr-only">Activity entries</caption>
          <thead>
            <tr>
              <th data-key="date">Date</th>
              <th data-key="value">Meters</th>
              <th>User</th>
            </tr>
          </thead>
          <tbody id="entriesBody">
            <tr class="loading-row"><td colspan="3">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>
      <div id="summary" class="subtle" style="font-size:.8rem;"></div>
    </section>
  </main>
  <footer class="app-footer"><small>&copy; <span id="year"></span></small></footer>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const btn = document.getElementById('toggleTheme'); const stored = localStorage.getItem('theme'); if(stored){document.documentElement.dataset.theme=stored;}
    btn.addEventListener('click',()=>{const next=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=next;localStorage.setItem('theme',next);});
    const bodyEl = document.getElementById('entriesBody');
    const filterDate = document.getElementById('filterDate');
    const clearBtn = document.getElementById('clearFilters');
    const summaryEl = document.getElementById('summary');
    let entries = []; let sortKey = 'date'; let sortDir = 'desc';
    function render(){
      const fd = filterDate.value.trim();
      let filtered = entries.filter(e => (!fd || e.date === fd));
      filtered.sort((a,b)=>{ if(a[sortKey] < b[sortKey]) return sortDir==='asc'? -1:1; if(a[sortKey] > b[sortKey]) return sortDir==='asc'? 1:-1; return 0; });
      if(!filtered.length){ bodyEl.innerHTML = '<tr><td colspan="3" class="empty">No matching entries.</td></tr>'; summaryEl.textContent=''; return; }
      bodyEl.innerHTML = filtered.map(e => `<tr><td><time datetime="${e.date}">${e.date}</time></td><td>${e.value}</td><td>${e.userId}</td></tr>`).join('');
      const total = filtered.reduce((s,e)=>s + (Number(e.value)||0),0);
      summaryEl.textContent = `Showing ${filtered.length} entries. Total meters: ${total}`;
    }
    fetch('/api/entries').then(r=>r.json()).then(data=>{ entries = data; render(); }).catch(()=>{ bodyEl.innerHTML='<tr><td colspan="3" class="error">Failed to load.</td></tr>'; });
    filterDate.addEventListener('change', render);
    clearBtn.addEventListener('click', ()=>{ filterDate.value=''; render(); });
    document.querySelectorAll('th[data-key]').forEach(th => {
      th.style.cursor='pointer';
      th.addEventListener('click', ()=>{ const k = th.dataset.key; if(sortKey === k){ sortDir = sortDir==='asc'?'desc':'asc'; } else { sortKey = k; sortDir='asc'; } render(); });
    });
  </script>
</body>
</html>
