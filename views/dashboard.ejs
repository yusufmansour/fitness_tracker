<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>My Progress</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="app">
  <%- include('partials/header', { activePage:'dashboard', user:user }) %>

  <main class="app-main">
    <section class="welcome card">
      <h1 class="page-title">My Progress</h1>
      <p class="subtle">Signed in as <strong><%= user.email %></strong></p>
      <% if (user.goalMeters) { %>
        <% const pctVal = user.goalMeters ? (user.totalMeters / user.goalMeters) * 100 : 0; %>
        <div class="goal-progress" style="margin-top:.75rem; display:grid; gap:.4rem;">
          <div style="font-size:.7rem;" class="subtle">Goal: <%= user.goalMeters.toLocaleString('en-US') %> m â€¢ Completed: <%= user.totalMeters.toLocaleString('en-US') %> m (<%= pctVal.toFixed(1) %>%)</div>
          <div class="goal-grid-wrapper" style="--goal-secondary:<%= user.shellSecondary || '#FFD447' %>;">
            <div class="goal-grid">
              <% for(let rowTop=0; rowTop<20; rowTop++){ for(let col=0; col<5; col++){ const seq=(19-rowTop)*5 + col + 1; const shouldLit = pctVal >= seq; %>
                <div class="cell" data-seq="<%= seq %>" data-lit="<%= shouldLit? '1':'0' %>" title="<%= seq %>%"></div>
              <% } } %>
            </div>
            <div class="goal-divider" style="top:0%;"><span class="goal-label">100%</span></div>
            <div class="goal-divider" style="top:25%;"><span class="goal-label">75%</span></div>
            <div class="goal-divider" style="top:50%;"><span class="goal-label">50%</span></div>
            <div class="goal-divider" style="top:75%;"><span class="goal-label">25%</span></div>
          </div>
        </div>
        <script>
          (function(){
            const cells=[...document.querySelectorAll('.goal-grid .cell')].sort((a,b)=> Number(a.dataset.seq)-Number(b.dataset.seq));
            let delay=0; const step=55; // ms per cell
            cells.forEach(cell=>{ if(cell.dataset.lit==='1'){ setTimeout(()=>{ cell.classList.add('lit'); }, delay); delay+=step; } });
          })();
        </script>
      <% } %>
    </section>

    <section class="recent card" id="recent">
      <div class="section-head">
        <h2>Recent Entries</h2>
      </div>
      <div id="entries" class="entries-grid" aria-live="polite">
        <div class="skeleton-list">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      </div>
    </section>

  </main>

  <footer class="app-footer">
    <small>&copy; <span id="year"></span> Activity Tracker</small>
  </footer>

  <script>
    // populate year
    document.getElementById('year').textContent = new Date().getFullYear();
    // theme toggle (guard for missing button)
    const toggleBtn = document.getElementById('toggleTheme');
    const stored = localStorage.getItem('theme');
    if(stored){ document.documentElement.dataset.theme = stored; }
    if(toggleBtn){
      toggleBtn.addEventListener('click', ()=>{
        const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = next;
        localStorage.setItem('theme', next);
      });
    }
    const currentUserId = '<%= user.id %>';
    // fetch & render entries
    fetch('/api/entries')
      .then(r => r.json())
      .then(entries => {
        const container = document.getElementById('entries');
        const userEntries = entries.filter(e => e.userId === currentUserId);
        const list = userEntries.slice(-10).reverse();
        if(!list.length){
          container.innerHTML = '<p class="empty">No entries yet.</p>';
          return;
        }
        container.innerHTML = list.map(e => `\n          <article class=\"entry-card\" data-id=\"${e.id}\">\n            <div class=\"entry-meta\">\n              <time datetime=\"${e.date}\">${e.date}</time>\n            </div>\n            <div class=\"entry-value\">${e.value}</div>\n          </article>`).join('');
      })
      .catch(err => {
        document.getElementById('entries').innerHTML = '<p class="error">Failed to load entries.</p>';
        console.error(err);
      });
  </script>
</body>
</html>
